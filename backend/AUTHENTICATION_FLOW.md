# Authentication Flow Explained üîê

## Is it normal to login without a token?

**YES! Absolutely normal.** Here's why:

## The Flow

### Step 1: Register (No token needed)
```bash
curl -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "John",
    "lastName": "Doe",
    "email": "john@example.com",
    "password": "password123",
    "dateOfBirth": "1995-05-15"
  }'
```

**Response:**
```json
{
  "message": "User registered successfully",
  "user": { /* user data without password */ }
}
```

**No token needed** because anyone should be able to create an account!

---

### Step 2: Login (No token needed - token is CREATED here)
```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "password123"
  }'
```

**Response:**
```json
{
  "message": "Login successful",
  "user": { /* user data */ },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ZWZmYmQ4ZTllZDZkOGUzMTZjZjRmMiIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYwNTU4MDUwLCJleHAiOjE3NjExNjI4NTB9.Ab7FLE1mG9BmEAT6W_ee9kiNpTj9Gy3QpgoBcDU-4g8"
}
```

**The token is GENERATED by the server** and given to you after successful login!

**Think of it like:**
- You walk into a hotel (register)
- You prove who you are at the front desk (login)
- They give you a room key card (token)
- You use the key card to access your room (protected endpoints)

---

### Step 3: Use Protected Endpoints (Token REQUIRED)

Now that you have the token, you use it to access protected resources:

```bash
# Save the token
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ZWZmYmQ4ZTllZDZkOGUzMTZjZjRmMiIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYwNTU4MDUwLCJleHAiOjE3NjExNjI4NTB9.Ab7FLE1mG9BmEAT6W_ee9kiNpTj9Gy3QpgoBcDU-4g8"

# Get your profile
curl -X GET http://localhost:5000/api/v1/users/me \
  -H "Authorization: Bearer $TOKEN"

# Update your profile
curl -X PUT http://localhost:5000/api/v1/users/me \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"firstName": "Jane"}'

# Get your saved nutrition plan
curl -X GET http://localhost:5000/api/v1/nutrition/my-plan \
  -H "Authorization: Bearer $TOKEN"
```

---

## Complete Example

```bash
#!/bin/bash

echo "========================================="
echo "Step 1: Register (No token needed)"
echo "========================================="
REGISTER_RESPONSE=$(curl -s -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Alice",
    "lastName": "Smith",
    "email": "alice@example.com",
    "password": "secure123",
    "dateOfBirth": "1992-03-20"
  }')

echo "‚úÖ Registered successfully!"
echo $REGISTER_RESPONSE | jq '.user | {id: ._id, name: "\(.firstName) \(.lastName)", email: .email}'
echo ""

EMAIL=$(echo $REGISTER_RESPONSE | jq -r '.user.email')

echo "========================================="
echo "Step 2: Login (No token needed)"
echo "========================================="
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d "{
    \"email\": \"$EMAIL\",
    \"password\": \"secure123\"
  }")

echo "‚úÖ Logged in successfully!"
TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.token')
echo "üìß Email: $EMAIL"
echo "üîë Token: ${TOKEN:0:50}..."
echo ""

echo "========================================="
echo "Step 3: Access Protected Endpoints"
echo "========================================="

echo "üìä Getting profile (WITH token)..."
PROFILE=$(curl -s -X GET http://localhost:5000/api/v1/users/me \
  -H "Authorization: Bearer $TOKEN")

echo "‚úÖ Profile retrieved!"
echo $PROFILE | jq '.user | {name: "\(.firstName) \(.lastName)", email: .email, role: .role}'
echo ""

echo "üßÆ Calculating nutrition (WITH token - saves to profile)..."
NUTRITION=$(curl -s -X POST http://localhost:5000/api/v1/nutrition/calculate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "weight": 70,
    "height": 170,
    "age": 32,
    "gender": "female",
    "activityLevel": "moderate",
    "goal": "fitness"
  }')

echo "‚úÖ Nutrition calculated and saved!"
echo $NUTRITION | jq '.data | {calories: .dailyCalories, protein: .proteinIntake, carbs: .carbIntake, fat: .fatIntake}'
echo ""

echo "üìã Getting saved nutrition plan..."
SAVED_PLAN=$(curl -s -X GET http://localhost:5000/api/v1/nutrition/my-plan \
  -H "Authorization: Bearer $TOKEN")

echo "‚úÖ Saved plan retrieved!"
echo $SAVED_PLAN | jq '.data'
echo ""

echo "========================================="
echo "What happens WITHOUT token?"
echo "========================================="

echo "‚ùå Trying to get profile without token..."
curl -s -X GET http://localhost:5000/api/v1/users/me | jq '.'
echo ""

echo "That's expected! Protected endpoints need authentication."
```

---

## Public vs Protected Endpoints

### ‚úÖ PUBLIC (No token needed)

**Why public?**
- Registration: Anyone can create an account
- Login: You need to prove identity to GET a token
- Nutrition Calculator: Free tool for anyone (even without account)
- Workout Customizer: Free tool for anyone (even without account)

```bash
# These work WITHOUT a token:
POST /api/v1/auth/register
POST /api/v1/auth/login
POST /api/v1/nutrition/calculate
POST /api/v1/workouts/customize
```

### üîí PROTECTED (Token required)

**Why protected?**
- Personal data (profile, saved plans)
- Account modifications
- User-specific information

```bash
# These REQUIRE a token:
GET  /api/v1/users/me
PUT  /api/v1/users/me
DELETE /api/v1/users/me
PUT  /api/v1/auth/update-password
GET  /api/v1/nutrition/my-plan
GET  /api/v1/workouts/my-plans
```

---

## What is JWT?

**JWT (JSON Web Token)** is like a secure ID card that:

1. **Is created** when you login
2. **Contains** your user ID and role
3. **Is signed** by the server (can't be faked)
4. **Expires** after 7 days (you need to login again)
5. **Is sent** with every protected request

### Token Structure

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9    ‚Üê Header (algorithm)
.
eyJpZCI6IjY4ZWZmYmQ4ZTllZDZkOGUzMTZ...   ‚Üê Payload (user data)
.
Ab7FLE1mG9BmEAT6W_ee9kiNpTj9Gy3Qpgo...   ‚Üê Signature (verification)
```

**Decoding the payload:**
```json
{
  "id": "68effbd8e9ed6d8e316cf4f2",
  "role": "user",
  "iat": 1760558050,  // Issued at
  "exp": 1761162850   // Expires at (7 days later)
}
```

---

## Security Features

### ‚úÖ Password Security
- Hashed with bcrypt (10 rounds)
- Never stored in plain text
- Never returned in responses

### ‚úÖ Token Security
- Signed with secret key (can't be forged)
- Expires after 7 days
- Contains minimal data (just ID and role)
- Sent via Authorization header (not in URL)

### ‚úÖ Authentication Flow
1. You send password ‚Üí Server verifies ‚Üí Server creates token
2. Server gives you token ‚Üí You store token
3. You send token with requests ‚Üí Server verifies token ‚Üí Access granted

---

## Common Questions

### Q: Can I use the token from someone else?
**A:** No, tokens are unique to each user and signed by the server.

### Q: What happens if token expires?
**A:** You get a 401 error and need to login again to get a new token.

### Q: Can I login without registering?
**A:** No, you must register first to create an account.

### Q: Can I use nutrition calculator without logging in?
**A:** Yes! It's a public endpoint. But your results won't be saved.

### Q: When should I send the token?
**A:** Only for protected endpoints (profile, saved data, account operations).

### Q: Where do I put the token?
**A:** In the `Authorization` header as `Bearer <token>`

---

## Summary

‚úÖ **Register** = No token needed (creating account)
‚úÖ **Login** = No token needed (getting the token)
‚úÖ **Protected endpoints** = Token required (using the token)

**This is the standard authentication flow used by most APIs!**

Your backend is implemented correctly! üéâ
